generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id            String            @id @default(cuid())
  name          String
  slug          String            @unique
  institutionType InstitutionType  @default(PUBLIC)
  gradeLevel    SchoolType        @default(GLOBAL) // ELEMENTARY, MIDDLE_SCHOOL, HIGH_SCHOOL, or MULTI_SCHOOL_CAMPUS
  physicalAddress String?
  district      String?
  website       String?
  phone         String?
  // Single-school contact info
  principalTitle String?
  principalName String?
  principalEmail String?
  principalPhone String?
  // Multi-school contact info (used when gradeLevel = MULTI_SCHOOL_CAMPUS)
  headOfSchoolsTitle String?
  headOfSchoolsName String?
  headOfSchoolsEmail String?
  headOfSchoolsPhone String?
  gradeRange    String?
  studentCount  Int?
  staffCount    Int?
  logoUrl       String?
  heroImageUrl  String?
  imagePosition ImagePosition     @default(LEFT)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  users         User[]
  tickets       Ticket[]
  events        Event[]
  draftEvents   DraftEvent[]
  inventory     InventoryItem[]
  schedules     TeacherSchedule[]
  roles         Role[]
  teams         Team[]
  buildings     Building[]
  areas         Area[]
  rooms         Room[]
  roomAssignments UserRoomAssignment[]
  schools       School[]
}

model User {
  id             String           @id @default(cuid())
  organizationId String
  schoolId       String?          // For users in multi-school campus organizations
  email          String
  name           String?          // Legacy: Use firstName + lastName
  firstName      String?
  lastName       String?
  schoolScope    SchoolType       @default(GLOBAL)
  phone          String?
  avatar         String?          // Profile image URL
  jobTitle       String?          // Job title separate from role
  employmentType EmploymentType?
  passwordHash   String
  status         UserStatus       @default(PENDING)
  role           UserRole         @default(VIEWER) // Deprecated: Use roleId instead
  roleId         String?
  teamIds        String[]         @default([])
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  school         School?          @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  userRole       Role?            @relation(fields: [roleId], references: [id], onDelete: SetNull)
  submittedEvent Event[]          @relation("SubmittedEventUser")
  submittedDraft DraftEvent[]     @relation("DraftEventUser")
  assignedTicket Ticket[]         @relation("AssignedTicketUser")
  schedules      TeacherSchedule[]
  passwordSetupTokens PasswordSetupToken[]
  roomAssignments UserRoomAssignment[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([schoolId])
  @@index([roleId])
  @@index([status])
}

model PasswordSetupToken {
  id         String   @id @default(cuid())
  userId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
}

model Ticket {
  id             String         @id @default(cuid())
  organizationId String
  title          String
  description    String?
  category       TicketCategory @default(MAINTENANCE)
  priority       TicketPriority @default(NORMAL)
  status         TicketStatus   @default(OPEN)
  source         TicketSource   @default(MANUAL)
  locationRefType LocationRefType?
  locationRefId   String?
  locationText    String?
  assignedToId   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedTo     User?          @relation("AssignedTicketUser", fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([organizationId, status])
  @@index([organizationId, category])
  @@index([organizationId, priority])
}

model Building {
  id             String         @id @default(cuid())
  organizationId String
  name           String
  code           String?
  schoolDivision SchoolDivision @default(GLOBAL)
  isActive       Boolean        @default(true)
  sortOrder      Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  areas          Area[]
  rooms          Room[]

  @@unique([organizationId, name])
  @@unique([organizationId, code])
  @@index([organizationId, isActive])
}

model Area {
  id             String       @id @default(cuid())
  organizationId String
  buildingId     String?
  name           String
  areaType       AreaType     @default(OTHER)
  isActive       Boolean      @default(true)
  sortOrder      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  building       Building?    @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  rooms          Room[]

  @@unique([organizationId, buildingId, name])
  @@index([organizationId, isActive])
  @@index([buildingId])
}

model Room {
  id             String       @id @default(cuid())
  organizationId String
  buildingId     String
  areaId         String?
  roomNumber     String
  displayName    String?
  floor          String?
  isActive       Boolean      @default(true)
  sortOrder      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  building       Building     @relation(fields: [buildingId], references: [id], onDelete: Restrict)
  area           Area?        @relation(fields: [areaId], references: [id], onDelete: SetNull)
  assignments    UserRoomAssignment[]

  @@unique([organizationId, buildingId, roomNumber])
  @@index([organizationId, isActive])
  @@index([buildingId])
  @@index([areaId])
}

model UserRoomAssignment {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  roomId         String
  isPrimary      Boolean      @default(false)
  startsAt       DateTime?
  endsAt         DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  room           Room         @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId])
  @@index([organizationId, roomId])
  @@index([isActive])
}

model School {
  id             String        @id @default(cuid())
  organizationId String
  name           String        // e.g., "Elementary Campus", "High School", "Middle School"
  gradeLevel     SchoolType    @default(ELEMENTARY) // ELEMENTARY | MIDDLE_SCHOOL | HIGH_SCHOOL
  principalTitle String?
  principalName  String?
  principalEmail String?
  principalPhone String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          User[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model Event {
  id             String        @id @default(cuid())
  organizationId String
  title          String
  description    String?
  room           String?
  startsAt       DateTime
  endsAt         DateTime
  status         EventStatus   @default(CONFIRMED)
  submittedById  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  submittedBy    User?         @relation("SubmittedEventUser", fields: [submittedById], references: [id], onDelete: SetNull)

  @@index([organizationId, startsAt])
}

model DraftEvent {
  id             String          @id @default(cuid())
  organizationId String
  title          String          @default("")
  description    String?         @default("")
  room           String?         @default("")
  startsAt       DateTime?
  endsAt         DateTime?
  status         DraftEventStatus @default(DRAFT)
  createdById    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User?           @relation("DraftEventUser", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([organizationId, updatedAt])
}

model InventoryItem {
  id               String        @id @default(cuid())
  organizationId   String
  name             String
  quantityOnHand   Int           @default(0)
  reorderThreshold Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
}

model TeacherSchedule {
  id             String       @id @default(cuid())
  organizationId String
  teacherName    String
  dayOfWeek      Int
  periodStart    String
  periodEnd      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  teacherId      String?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teacher        User?        @relation(fields: [teacherId], references: [id], onDelete: SetNull)

  @@index([organizationId, dayOfWeek])
}

model Permission {
  id          String           @id @default(cuid())
  resource    String           // "tickets", "events", "inventory", "settings"
  action      String           // "create", "read", "update", "delete", "approve"
  scope       String           @default("global") // "own", "team", "all", "global"
  description String?
  createdAt   DateTime         @default(now())
  roles       RolePermission[]

  @@unique([resource, action, scope])
  @@index([resource, action])
}

model Role {
  id             String           @id @default(cuid())
  organizationId String
  name           String           // "Super Admin", "IT Staff", "Teacher"
  slug           String           // "super-admin", "it-staff", "teacher"
  description    String?
  isSystem       Boolean          @default(false) // true for pre-built roles
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions    RolePermission[]
  users          User[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Team {
  id             String       @id @default(cuid())
  organizationId String
  name           String       // "IT Support", "Maintenance", "Room 102"
  slug           String       // "it-support", "maintenance", "room-102"
  description    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([organizationId])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  OPERATIONS
  TEACHER
  VIEWER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

enum TicketCategory {
  MAINTENANCE
  IT
  EVENT
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

enum LocationRefType {
  ROOM
  AREA
  BUILDING
  FREE_TEXT
}

enum SchoolDivision {
  ELEMENTARY
  MIDDLE_SCHOOL
  HIGH_SCHOOL
  GLOBAL
}

enum AreaType {
  FIELD
  COURT
  GYM
  COMMON
  PARKING
  OTHER
}

enum TicketSource {
  MANUAL
  SHADOW_EVENT_AUTOMATION
}

enum EventStatus {
  DRAFT
  CONFIRMED
  CANCELLED
}

enum DraftEventStatus {
  DRAFT
  READY
  SUBMITTED
}

enum ImagePosition {
  LEFT
  RIGHT
}

enum SchoolType {
  ELEMENTARY
  MIDDLE_SCHOOL
  HIGH_SCHOOL
  GLOBAL
  MULTI_SCHOOL_CAMPUS
}

enum InstitutionType {
  PUBLIC
  PRIVATE
  CHARTER
  HYBRID
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
  VOLUNTEER
}
