generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id            String            @id @default(cuid())
  name          String
  slug          String            @unique
  institutionType InstitutionType  @default(PUBLIC)
  gradeLevel    SchoolType        @default(GLOBAL) // ELEMENTARY, MIDDLE_SCHOOL, HIGH_SCHOOL, or MULTI_SCHOOL_CAMPUS
  physicalAddress String?
  district      String?
  website       String?
  phone         String?
  // Single-school contact info
  principalName String?
  principalEmail String?
  principalPhone String?
  // Multi-school contact info (used when gradeLevel = MULTI_SCHOOL_CAMPUS)
  headOfSchoolsName String?
  headOfSchoolsEmail String?
  headOfSchoolsPhone String?
  gradeRange    String?
  studentCount  Int?
  staffCount    Int?
  latitude      Float?
  longitude     Float?
  logoUrl       String?
  heroImageUrl  String?
  theme         String?           // JSON or string for tenant theme config
  imagePosition ImagePosition     @default(LEFT)
  // Platform admin fields
  stripeCustomerId  String?       // Stripe Customer ID for billing
  onboardingStatus  OnboardingStatus @default(SIGNED_UP)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  users         User[]
  tickets       Ticket[]
  events        Event[]
  draftEvents   DraftEvent[]
  inventory     InventoryItem[]
  schedules     TeacherSchedule[]
  roles         Role[]
  teams         Team[]
  buildings     Building[]
  areas         Area[]
  rooms         Room[]
  roomAssignments UserRoomAssignment[]
  campuses      Campus[]
  campusAssignments UserCampusAssignment[]
  schools       School[]
  auditLogs     AuditLog[]
  // Platform admin relations
  subscriptions       Subscription[]
  payments            Payment[]
  discountRedemptions DiscountRedemption[]
  platformTickets     PlatformSupportTicket[]
  // Calendar module relations
  calendars           Calendar[]
  calendarEvents      CalendarEvent[]
  calendarCategories  CalendarCategory[]
  feedConnections     CalendarFeedConnection[]
  academicYears       AcademicYear[]
  terms               Term[]
  markingPeriods      MarkingPeriod[]
  bellSchedules       BellSchedule[]
  dayScheduleAssignments DayScheduleAssignment[]
  specialDays         SpecialDay[]
  planningSeasons     PlanningSeason[]
  planningSubmissions PlanningSubmission[]
  approvalChannelConfigs ApprovalChannelConfig[]
  eventResourceRequests  EventResourceRequest[]
  tenantModules       TenantModule[]

  @@index([onboardingStatus])
}

model User {
  id             String           @id @default(cuid())
  organizationId String
  schoolId       String?          // For users in multi-school campus organizations
  email          String
  name           String?          // Legacy: Use firstName + lastName
  firstName      String?
  lastName       String?
  schoolScope    SchoolType       @default(GLOBAL)
  phone          String?
  avatar         String?          // Profile image URL
  jobTitle       String?          // Job title separate from role
  employmentType EmploymentType?
  passwordHash   String?          // Nullable for OAuth-only users
  status         UserStatus       @default(PENDING)
  roleId         String?
  authMethod     AuthMethod       @default(EMAIL)
  googleId       String?          @unique
  microsoftId    String?          @unique
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  school         School?          @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  userRole       Role?            @relation(fields: [roleId], references: [id], onDelete: SetNull)
  teams          UserTeam[]
  accounts       Account[]
  submittedEvent Event[]          @relation("SubmittedEventUser")
  submittedDraft DraftEvent[]     @relation("DraftEventUser")
  assignedTicket Ticket[]         @relation("AssignedTicketUser")
  schedules      TeacherSchedule[]
  passwordSetupTokens PasswordSetupToken[]
  roomAssignments UserRoomAssignment[]
  campusAssignments UserCampusAssignment[]
  userPermissions UserPermission[]
  // Calendar module relations
  calendarSubscriptions CalendarSubscription[]
  eventAttendances      EventAttendee[]
  feedConnections       CalendarFeedConnection[]
  createdCalendarEvents CalendarEvent[]   @relation("CalendarEventCreator")
  approvedCalendarEvents CalendarEvent[]  @relation("CalendarEventApprover")
  approvalResponses     EventApproval[]   @relation("ApprovalResponder")
  resourceResponses     EventResourceRequest[] @relation("ResourceResponder")
  planningSubmissions   PlanningSubmission[] @relation("PlanningSubmitter")
  planningComments      PlanningComment[]    @relation("PlanningCommentAuthor")

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([schoolId])
  @@index([roleId])
  @@index([status])
  @@index([organizationId, deletedAt])
}

model PasswordSetupToken {
  id         String   @id @default(cuid())
  userId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
}

model Ticket {
  id             String         @id @default(cuid())
  organizationId String
  campusId       String?        // FK to Campus — scopes ticket to a physical location
  schoolId       String?        // FK to School — scopes ticket to an academic unit
  title          String
  description    String?
  category       TicketCategory @default(MAINTENANCE)
  priority       TicketPriority @default(NORMAL)
  status         TicketStatus   @default(OPEN)
  source         TicketSource   @default(MANUAL)
  locationRefType LocationRefType?
  locationRefId   String?
  locationText    String?
  assignedToId   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campus         Campus?        @relation(fields: [campusId], references: [id], onDelete: SetNull)
  school         School?        @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  assignedTo     User?          @relation("AssignedTicketUser", fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([organizationId, status])
  @@index([organizationId, category])
  @@index([organizationId, priority])
  @@index([organizationId, deletedAt])
  @@index([organizationId, campusId])
  @@index([schoolId])
}

model Building {
  id             String         @id @default(cuid())
  organizationId String
  campusId       String?        // FK to Campus — optional during migration, will become required
  schoolId       String?        // FK to School — set for school-specific buildings
  name           String
  code           String?
  address        String?
  latitude             Float?
  longitude            Float?
  polygonCoordinates   Json?              // Array of {lat, lng} points defining building outline
  schoolDivision SchoolDivision @default(GLOBAL)
  buildingType   BuildingType   @default(GENERAL)
  images         Json?          // Array of image URLs, max 4
  isActive       Boolean        @default(true)
  sortOrder      Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campus         Campus?        @relation(fields: [campusId], references: [id], onDelete: Restrict)
  school         School?        @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  areas          Area[]
  rooms          Room[]
  calendarEvents CalendarEvent[]

  @@unique([organizationId, name])
  @@unique([organizationId, code])
  @@index([organizationId, isActive])
  @@index([organizationId, deletedAt])
  @@index([campusId])
  @@index([schoolId])
}

model Area {
  id             String       @id @default(cuid())
  organizationId String
  campusId       String?      // FK to Campus — optional during migration, will become required
  buildingId     String?
  name           String
  areaType       AreaType     @default(OTHER)
  latitude       Float?
  longitude      Float?
  polygonCoordinates Json?     // Array of {lat, lng} for outdoor space outline
  images         Json?        // Array of image URLs, max 4
  isActive       Boolean      @default(true)
  sortOrder      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campus         Campus?      @relation(fields: [campusId], references: [id], onDelete: Restrict)
  building       Building?    @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  rooms          Room[]
  calendarEvents CalendarEvent[]

  @@unique([organizationId, buildingId, name])
  @@index([organizationId, isActive])
  @@index([campusId])
  @@index([buildingId])
  @@index([organizationId, deletedAt])
}

model Room {
  id             String       @id @default(cuid())
  organizationId String
  buildingId     String
  areaId         String?
  roomNumber     String
  displayName    String?
  floor          String?
  images         Json?        // Array of image URLs, max 4
  isActive       Boolean      @default(true)
  sortOrder      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  building       Building     @relation(fields: [buildingId], references: [id], onDelete: Restrict)
  area           Area?        @relation(fields: [areaId], references: [id], onDelete: SetNull)
  assignments    UserRoomAssignment[]

  @@unique([organizationId, buildingId, roomNumber])
  @@index([organizationId, isActive])
  @@index([buildingId])
  @@index([areaId])
  @@index([organizationId, deletedAt])
}

model UserRoomAssignment {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  roomId         String
  isPrimary      Boolean      @default(false)
  startsAt       DateTime?
  endsAt         DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  room           Room         @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId])
  @@index([organizationId, roomId])
  @@index([isActive])
}

model Campus {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  address        String?
  latitude       Float?
  longitude      Float?
  campusType     CampusType   @default(CAMPUS)
  isActive       Boolean      @default(true)
  sortOrder      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  schools        School[]
  buildings      Building[]
  areas          Area[]
  tickets        Ticket[]
  userAssignments UserCampusAssignment[]
  // Calendar module relations
  calendars      Calendar[]
  dayScheduleAssignments DayScheduleAssignment[]
  specialDays    SpecialDay[]
  planningSeasons PlanningSeason[]
  approvalChannelConfigs ApprovalChannelConfig[]

  @@unique([organizationId, name])
  @@index([organizationId, isActive])
  @@index([organizationId, deletedAt])
}

model UserCampusAssignment {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  campusId       String
  isPrimary      Boolean      @default(false)
  startsAt       DateTime?
  endsAt         DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  campus         Campus       @relation(fields: [campusId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId])
  @@index([organizationId, campusId])
  @@index([isActive])
}

model School {
  id               String        @id @default(cuid())
  organizationId   String
  campusId         String?       // FK to Campus — optional during migration, will become required
  name             String        // e.g., "Elementary Campus", "High School", "Middle School"
  gradeLevel       SchoolType    @default(ELEMENTARY) // ELEMENTARY | MIDDLE_SCHOOL | HIGH_SCHOOL
  color            String        @default("#3b82f6")
  principalName    String?
  principalEmail   String?
  principalPhone   String?
  principalPhoneExt String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campus         Campus?       @relation(fields: [campusId], references: [id], onDelete: Restrict)
  users          User[]
  buildings      Building[]
  tickets        Ticket[]
  // Calendar module relations
  calendars      Calendar[]
  calendarEvents CalendarEvent[]
  academicYears  AcademicYear[]
  bellSchedules  BellSchedule[]
  specialDays    SpecialDay[]
  planningSeasons PlanningSeason[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([campusId])
  @@index([organizationId, deletedAt])
}

model Event {
  id             String        @id @default(cuid())
  organizationId String
  title          String
  description    String?
  room           String?
  startsAt       DateTime
  endsAt         DateTime
  status         EventStatus   @default(CONFIRMED)
  submittedById  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  submittedBy    User?         @relation("SubmittedEventUser", fields: [submittedById], references: [id], onDelete: SetNull)

  @@index([organizationId, startsAt])
  @@index([organizationId, deletedAt])
}

model DraftEvent {
  id             String          @id @default(cuid())
  organizationId String
  title          String          @default("")
  description    String?         @default("")
  room           String?         @default("")
  startsAt       DateTime?
  endsAt         DateTime?
  status         DraftEventStatus @default(DRAFT)
  createdById    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User?           @relation("DraftEventUser", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([organizationId, updatedAt])
  @@index([organizationId, deletedAt])
}

model InventoryItem {
  id               String        @id @default(cuid())
  organizationId   String
  name             String
  quantityOnHand   Int           @default(0)
  reorderThreshold Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?
  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, deletedAt])
}

model TeacherSchedule {
  id             String       @id @default(cuid())
  organizationId String
  teacherName    String
  dayOfWeek      Int
  periodStart    String
  periodEnd      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  teacherId      String?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teacher        User?        @relation(fields: [teacherId], references: [id], onDelete: SetNull)

  @@index([organizationId, dayOfWeek])
}

model Permission {
  id          String           @id @default(cuid())
  resource    String           // "tickets", "events", "inventory", "settings"
  action      String           // "create", "read", "update", "delete", "approve"
  scope       String           @default("global") // "own", "team", "all", "global"
  description String?
  createdAt      DateTime         @default(now())
  roles          RolePermission[]
  userOverrides  UserPermission[]

  @@unique([resource, action, scope])
  @@index([resource, action])
}

model Role {
  id             String           @id @default(cuid())
  organizationId String
  name           String           // "Super Admin", "IT Staff", "Teacher"
  slug           String           // "super-admin", "it-staff", "teacher"
  description    String?
  isSystem       Boolean          @default(false) // true for pre-built roles
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions    RolePermission[]
  users          User[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserPermission {
  userId       String
  permissionId String
  granted      Boolean    @default(true) // true = grant override, false = revoke override
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

model Team {
  id             String       @id @default(cuid())
  organizationId String
  name           String       // "IT Support", "Maintenance", "Room 102"
  slug           String       // "it-support", "maintenance", "room-102"
  description    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        UserTeam[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model UserTeam {
  userId    String
  teamId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([userId, teamId])
  @@index([userId])
  @@index([teamId])
}

model AuditLog {
  id             String       @id @default(cuid())
  organizationId String
  userId         String?      // null for system-generated events
  userEmail      String?      // denormalized — survives user deletion
  action         String       // e.g. "user.invite", "role.delete", "user.login"
  resourceType   String?      // e.g. "User", "Role", "Team"
  resourceId     String?      // UUID of the affected record
  resourceLabel  String?      // human-readable name at the time of action
  changes        Json?        // structured metadata (fields changed, new values, etc.)
  ipAddress      String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, resourceType])
  @@index([userId])
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

enum TicketCategory {
  MAINTENANCE
  IT
  EVENT
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

enum LocationRefType {
  ROOM
  AREA
  BUILDING
  FREE_TEXT
}

enum SchoolDivision {
  ELEMENTARY
  MIDDLE_SCHOOL
  HIGH_SCHOOL
  GLOBAL
}

enum BuildingType {
  GENERAL
  ARTS_CULTURE
  ATHLETICS
  ADMINISTRATION
  SUPPORT_SERVICES
}

enum AreaType {
  FIELD
  COURT
  GYM
  COMMON
  PARKING
  OTHER
}

enum TicketSource {
  MANUAL
  SHADOW_EVENT_AUTOMATION
}

enum EventStatus {
  DRAFT
  CONFIRMED
  CANCELLED
}

enum DraftEventStatus {
  DRAFT
  READY
  SUBMITTED
}

enum ImagePosition {
  LEFT
  RIGHT
}

enum SchoolType {
  ELEMENTARY
  MIDDLE_SCHOOL
  HIGH_SCHOOL
  GLOBAL
  MULTI_SCHOOL_CAMPUS
}

enum InstitutionType {
  PUBLIC
  PRIVATE
  CHARTER
  HYBRID
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
  VOLUNTEER
}

// ─── Platform Admin Enums ────────────────────────────────────────────

enum OnboardingStatus {
  SIGNED_UP
  ONBOARDING
  ACTIVE
  SUSPENDED
  CHURNED
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
}

enum PaymentStatus {
  SUCCEEDED
  FAILED
  PENDING
  REFUNDED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PlatformTicketCategory {
  BUG
  FEATURE_REQUEST
  BILLING
  GENERAL
}

enum PlatformTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  RESOLVED
  CLOSED
}

enum PlatformAdminRole {
  SUPER_ADMIN
  OPERATOR
}

enum PlatformSenderType {
  PLATFORM_ADMIN
  ORG_USER
}

enum AuthMethod {
  EMAIL
  GOOGLE
  MICROSOFT
}

enum CampusType {
  HEADQUARTERS
  CAMPUS
  SATELLITE
}

// ─── OAuth Account Model (Auth.js adapter) ──────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// ─── Platform Admin Models ───────────────────────────────────────────

model PlatformAdmin {
  id           String            @id @default(cuid())
  email        String            @unique
  passwordHash String
  name         String?
  role         PlatformAdminRole @default(OPERATOR)
  lastLoginAt  DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  assignedTickets PlatformSupportTicket[] @relation("AssignedPlatformAdmin")
  auditLogs       PlatformAuditLog[]
}

model SubscriptionPlan {
  id             String   @id @default(cuid())
  name           String   // "Free Trial", "Basic", "Pro", "Enterprise"
  slug           String   @unique // "free-trial", "basic", "pro", "enterprise"
  stripePriceId  String?  // Stripe Price ID (monthly)
  monthlyPrice   Int      @default(0) // cents (e.g., 4999 = $49.99)
  annualPrice    Int?     // cents — optional annual billing
  features       Json?    // { "maxUsers": 50, "aiEnabled": true, ... }
  trialDays      Int      @default(0) // 0 = no trial, 30 = 30-day trial
  isActive       Boolean  @default(true)
  displayOrder   Int      @default(0) // sort order for plan selection UI
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  subscriptions Subscription[]

  @@index([isActive, displayOrder])
}

model Subscription {
  id                    String             @id @default(cuid())
  organizationId        String
  planId                String
  stripeSubscriptionId  String?            @unique
  stripeCustomerId      String?
  status                SubscriptionStatus @default(TRIALING)
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean            @default(false)
  trialEndsAt           DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan         SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)
  payments     Payment[]

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([status])
  @@index([stripeCustomerId])
}

model Payment {
  id                   String        @id @default(cuid())
  organizationId       String
  subscriptionId       String?
  stripeInvoiceId      String?       @unique
  stripePaymentIntentId String?
  amount               Int           // cents
  currency             String        @default("usd")
  status               PaymentStatus @default(PENDING)
  paidAt               DateTime?
  createdAt            DateTime      @default(now())

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([status])
}

model DiscountCode {
  id                 String       @id @default(cuid())
  code               String       @unique
  type               DiscountType @default(PERCENTAGE)
  value              Int          // percentage (e.g., 20 = 20%) or cents (e.g., 1000 = $10)
  maxRedemptions     Int?         // null = unlimited
  currentRedemptions Int          @default(0)
  validFrom          DateTime     @default(now())
  validUntil         DateTime?    // null = no expiry
  isActive           Boolean      @default(true)
  stripeCouponId     String?      // Stripe Coupon ID
  description        String?      // internal note
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  redemptions DiscountRedemption[]

  @@index([isActive])
  @@index([validUntil])
}

model DiscountRedemption {
  id                String   @id @default(cuid())
  discountCodeId    String
  organizationId    String
  redeemedAt        DateTime @default(now())
  stripePromotionId String?  // Stripe Promotion Code ID

  discountCode DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([discountCodeId, organizationId]) // each org can redeem a code only once
  @@index([organizationId])
}

model PlatformSupportTicket {
  id                String                @id @default(cuid())
  organizationId    String?               // null for platform-internal tickets
  submittedByUserId String?               // org user who submitted (null for admin-created)
  assignedToAdminId String?               // platform admin assigned to handle
  subject           String
  description       String
  category          PlatformTicketCategory @default(GENERAL)
  priority          TicketPriority         @default(NORMAL) // reuse existing enum
  status            PlatformTicketStatus   @default(OPEN)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  organization Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  assignedTo   PlatformAdmin? @relation("AssignedPlatformAdmin", fields: [assignedToAdminId], references: [id], onDelete: SetNull)
  messages     PlatformSupportMessage[]

  @@index([status, createdAt(sort: Desc)])
  @@index([organizationId])
  @@index([assignedToAdminId])
  @@index([priority])
}

model PlatformSupportMessage {
  id         String             @id @default(cuid())
  ticketId   String
  senderType PlatformSenderType
  senderId   String             // PlatformAdmin.id or User.id depending on senderType
  message    String
  createdAt  DateTime           @default(now())

  ticket PlatformSupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
}

model PlatformAuditLog {
  id              String   @id @default(cuid())
  platformAdminId String
  action          String   // e.g., "org.suspend", "plan.create", "ticket.assign"
  resourceType    String?  // e.g., "Organization", "SubscriptionPlan", "PlatformSupportTicket"
  resourceId      String?
  details         Json?    // structured change data
  ipAddress       String?
  createdAt       DateTime @default(now())

  admin PlatformAdmin @relation(fields: [platformAdminId], references: [id], onDelete: Cascade)

  @@index([platformAdminId])
  @@index([createdAt(sort: Desc)])
  @@index([resourceType])
}

// ═══════════════════════════════════════════════════════════════════════
// CALENDAR MODULE
// ═══════════════════════════════════════════════════════════════════════

model Calendar {
  id                    String             @id @default(cuid())
  organizationId        String
  campusId              String?
  schoolId              String?
  name                  String
  slug                  String
  calendarType          CalendarType
  color                 String             @default("#3b82f6") // Hex color for UI
  visibility            CalendarVisibility @default(ORG_WIDE)
  requiresApproval      Boolean            @default(false)
  defaultApproverRoleId String?
  isDefault             Boolean            @default(false) // Auto-subscribe new users
  feedToken             String?            @unique         // Token for iCal feed URL
  isActive              Boolean            @default(true)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  deletedAt             DateTime?

  organization  Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campus        Campus?                @relation(fields: [campusId], references: [id], onDelete: SetNull)
  school        School?                @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  events        CalendarEvent[]
  subscriptions CalendarSubscription[]
  categories    CalendarCategory[]

  @@unique([organizationId, slug])
  @@index([organizationId, calendarType])
  @@index([organizationId, isActive])
  @@index([campusId])
  @@index([schoolId])
  @@index([organizationId, deletedAt])
}

model CalendarEvent {
  id              String              @id @default(cuid())
  calendarId      String
  organizationId  String
  schoolId        String?
  title           String
  description     String?
  startTime       DateTime
  endTime         DateTime
  timezone        String              @default("America/Chicago") // IANA timezone
  isAllDay        Boolean             @default(false)
  calendarStatus  CalendarEventStatus @default(DRAFT)
  rrule           String?             // RFC 5545 recurrence rule
  parentEventId   String?             // For recurring event exceptions
  originalStart   DateTime?           // Original start time for exceptions
  categoryId      String?
  locationText    String?
  buildingId      String?
  areaId          String?
  sourceModule    String?             // 'athletics', 'timetable', etc.
  sourceId        String?             // ID in source module
  createdById     String?
  approvedById    String?
  metadata        Json?               // Extensible data bag
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  deletedAt       DateTime?

  calendar    Calendar          @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  school      School?           @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  parentEvent CalendarEvent?    @relation("RecurringExceptions", fields: [parentEventId], references: [id], onDelete: SetNull)
  exceptions  CalendarEvent[]   @relation("RecurringExceptions")
  category    CalendarCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  building    Building?         @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  area        Area?             @relation(fields: [areaId], references: [id], onDelete: SetNull)
  createdBy   User?             @relation("CalendarEventCreator", fields: [createdById], references: [id], onDelete: SetNull)
  approvedBy  User?             @relation("CalendarEventApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  attendees   EventAttendee[]
  approvals   EventApproval[]
  resourceRequests EventResourceRequest[]
  syncMappings     EventSyncMapping[]

  @@index([calendarId, startTime, endTime])
  @@index([organizationId, startTime])
  @@index([parentEventId])
  @@index([sourceModule, sourceId])
  @@index([organizationId, deletedAt])
  @@index([createdById])
  @@index([calendarStatus])
  @@index([schoolId])
  @@index([buildingId])
  @@index([areaId])
}

model CalendarCategory {
  id             String       @id @default(cuid())
  organizationId String
  calendarId     String?      // Optional: category can be global or per-calendar
  name           String
  color          String       @default("#6b7280")
  icon           String?      // Lucide icon name
  calendarType   CalendarType? // Restrict to a calendar type
  isSystem       Boolean      @default(false)
  sortOrder      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  calendar     Calendar?       @relation(fields: [calendarId], references: [id], onDelete: SetNull)
  events       CalendarEvent[]

  @@unique([organizationId, name])
  @@index([organizationId, calendarType])
  @@index([calendarId])
}

model CalendarSubscription {
  id                  String   @id @default(cuid())
  userId              String
  calendarId          String
  isVisible           Boolean  @default(true)
  notifyOnNew         Boolean  @default(false)
  notifyBeforeMinutes Int?     // e.g., 15, 30, 60
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  calendar Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@unique([userId, calendarId])
  @@index([userId])
  @@index([calendarId])
}

model EventAttendee {
  id             String         @id @default(cuid())
  eventId        String
  userId         String
  responseStatus RSVPStatus     @default(PENDING)
  respondedAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model CalendarFeedConnection {
  id               String       @id @default(cuid())
  organizationId   String
  userId           String
  provider         SyncProvider
  accessTokenEnc   String       // Encrypted OAuth access token
  refreshTokenEnc  String?      // Encrypted OAuth refresh token
  tokenExpiresAt   DateTime?
  externalCalendarId String?    // Provider calendar ID
  syncToken        String?      // Incremental sync token
  webhookChannelId String?      // Google/Microsoft webhook channel ID
  webhookExpiresAt DateTime?
  lastSyncAt       DateTime?
  syncStatus       SyncStatus   @default(ACTIVE)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncMappings EventSyncMapping[]

  @@unique([organizationId, userId, provider])
  @@index([organizationId])
  @@index([userId])
  @@index([syncStatus])
}

model EventSyncMapping {
  id              String       @id @default(cuid())
  connectionId    String
  internalEventId String
  externalEventId String
  provider        SyncProvider
  checksum        String?      // SHA-256 for loop prevention
  syncVersion     Int          @default(0)
  lastSyncedAt    DateTime     @default(now())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  connection CalendarFeedConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  event      CalendarEvent          @relation(fields: [internalEventId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalEventId])
  @@index([internalEventId])
  @@index([connectionId])
}

// ─── Academic Calendar Models ──────────────────────────────────────────

model AcademicYear {
  id             String   @id @default(cuid())
  organizationId String
  schoolId       String?
  name           String   // "2025-2026"
  startDate      DateTime
  endDate        DateTime
  isCurrent      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  school       School?      @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  terms        Term[]

  @@unique([organizationId, name])
  @@index([organizationId, isCurrent])
  @@index([schoolId])
}

model Term {
  id             String   @id @default(cuid())
  organizationId String
  academicYearId String
  name           String   // "Fall Semester", "Q1"
  startDate      DateTime
  endDate        DateTime
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  academicYear AcademicYear   @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  markingPeriods MarkingPeriod[]

  @@index([organizationId])
  @@index([academicYearId])
}

model MarkingPeriod {
  id             String   @id @default(cuid())
  organizationId String
  termId         String
  name           String   // "Quarter 1", "Midterm"
  startDate      DateTime
  endDate        DateTime
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  term         Term         @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([termId])
}

model BellSchedule {
  id             String   @id @default(cuid())
  organizationId String
  schoolId       String?
  name           String   // "Regular", "Early Release", "2-Hour Delay"
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  school       School?              @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  periods      BellSchedulePeriod[]
  dayAssignments DayScheduleAssignment[]

  @@unique([organizationId, schoolId, name])
  @@index([organizationId])
  @@index([schoolId])
}

model BellSchedulePeriod {
  id             String   @id @default(cuid())
  bellScheduleId String
  name           String   // "Period 1", "Lunch", "Advisory"
  startTime      String   // "08:00" (HH:mm)
  endTime        String   // "08:50"
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())

  bellSchedule BellSchedule @relation(fields: [bellScheduleId], references: [id], onDelete: Cascade)

  @@index([bellScheduleId])
}

model DayScheduleAssignment {
  id             String   @id @default(cuid())
  organizationId String
  campusId       String?
  bellScheduleId String
  date           DateTime @db.Date
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campus       Campus?      @relation(fields: [campusId], references: [id], onDelete: SetNull)
  bellSchedule BellSchedule @relation(fields: [bellScheduleId], references: [id], onDelete: Cascade)

  @@unique([organizationId, campusId, date])
  @@index([organizationId, date])
  @@index([campusId])
}

model SpecialDay {
  id             String         @id @default(cuid())
  organizationId String
  schoolId       String?
  campusId       String?
  date           DateTime       @db.Date
  name           String
  specialDayType SpecialDayType
  isAllSchools   Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  school       School?      @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  campus       Campus?      @relation(fields: [campusId], references: [id], onDelete: SetNull)

  @@index([organizationId, date])
  @@index([schoolId])
  @@index([campusId])
}

// ─── Event Planning Season Models ──────────────────────────────────────

model PlanningSeason {
  id               String              @id @default(cuid())
  organizationId   String
  campusId         String?
  schoolId         String?
  name             String              // "2026-2027 Event Planning"
  startDate        DateTime
  endDate          DateTime
  submissionOpen   DateTime
  submissionClose  DateTime
  finalizationDeadline DateTime?
  budgetCap        Float?
  phase            PlanningPhase       @default(SETUP)
  historicalSeasonId String?           // Link to previous year's season
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  organization Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campus       Campus?                @relation(fields: [campusId], references: [id], onDelete: SetNull)
  school       School?                @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  submissions  PlanningSubmission[]
  blackoutDates PlanningBlackoutDate[]
  conflicts    PlanningConflict[]

  @@index([organizationId, phase])
  @@index([campusId])
  @@index([schoolId])
}

model PlanningBlackoutDate {
  id               String   @id @default(cuid())
  planningSeasonId String
  date             DateTime @db.Date
  reason           String?  // "State Testing", "Holiday", "Board Meeting"
  createdAt        DateTime @default(now())

  planningSeason PlanningSeason @relation(fields: [planningSeasonId], references: [id], onDelete: Cascade)

  @@index([planningSeasonId, date])
}

model PlanningSubmission {
  id                 String                @id @default(cuid())
  planningSeasonId   String
  organizationId     String
  submittedById      String
  title              String
  description        String?
  preferredDate      DateTime
  alternateDate1     DateTime?
  alternateDate2     DateTime?
  duration           Int                   // Minutes
  isOutdoor          Boolean               @default(false)
  expectedAttendance Int?
  targetAudience     String?
  priority           SubmissionPriority    @default(IMPORTANT)
  estimatedBudget    Float?
  submissionStatus   PlanningSubmissionStatus @default(DRAFT)
  adminNotes         String?               // Notes from War Room
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  planningSeason PlanningSeason       @relation(fields: [planningSeasonId], references: [id], onDelete: Cascade)
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  submittedBy    User                 @relation("PlanningSubmitter", fields: [submittedById], references: [id], onDelete: Cascade)
  resourceNeeds  PlanningResourceNeed[]
  comments       PlanningComment[]

  @@index([planningSeasonId])
  @@index([organizationId])
  @@index([submittedById])
  @@index([submissionStatus])
}

model PlanningResourceNeed {
  id                   String   @id @default(cuid())
  planningSubmissionId String
  resourceType         ResourceRequestType
  details              String?  // Description of the need
  createdAt            DateTime @default(now())

  planningSubmission PlanningSubmission @relation(fields: [planningSubmissionId], references: [id], onDelete: Cascade)

  @@index([planningSubmissionId])
}

model PlanningComment {
  id                   String   @id @default(cuid())
  planningSubmissionId String
  authorId             String
  message              String
  isAdminOnly          Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  planningSubmission PlanningSubmission @relation(fields: [planningSubmissionId], references: [id], onDelete: Cascade)
  author             User               @relation("PlanningCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([planningSubmissionId, createdAt])
  @@index([authorId])
}

model PlanningConflict {
  id               String            @id @default(cuid())
  planningSeasonId String
  conflictType     ConflictType
  severity         ConflictSeverity
  description      String
  affectedIds      Json              // Array of submission IDs
  suggestedResolution String?
  isResolved       Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  planningSeason PlanningSeason @relation(fields: [planningSeasonId], references: [id], onDelete: Cascade)

  @@index([planningSeasonId, isResolved])
}

// ─── Approval & Resource Request Models ────────────────────────────────

model ApprovalChannelConfig {
  id               String             @id @default(cuid())
  organizationId   String
  campusId         String?
  channelType      ApprovalChannel
  mode             ApprovalMode       @default(REQUIRED)
  assignedTeamId   String?            // Team responsible for this channel
  escalationHours  Int                @default(72)
  autoApproveIfNoResource Boolean     @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campus       Campus?      @relation(fields: [campusId], references: [id], onDelete: SetNull)

  @@unique([organizationId, campusId, channelType])
  @@index([organizationId])
  @@index([campusId])
}

model EventApproval {
  id            String            @id @default(cuid())
  eventId       String
  channelType   ApprovalChannel
  approvalStatus ApprovalStatus   @default(PENDING)
  respondedById String?
  respondedAt   DateTime?
  reason        String?           // Rejection/revision reason
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  event       CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  respondedBy User?         @relation("ApprovalResponder", fields: [respondedById], references: [id], onDelete: SetNull)

  @@unique([eventId, channelType])
  @@index([eventId])
  @@index([approvalStatus])
  @@index([respondedById])
}

model EventResourceRequest {
  id            String              @id @default(cuid())
  eventId       String
  organizationId String
  resourceType  ResourceRequestType
  requestStatus ResourceRequestStatus @default(PENDING)
  details       Json?               // Typed metadata per resource type
  respondedById String?
  respondedAt   DateTime?
  responseNote  String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  event        CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  respondedBy  User?         @relation("ResourceResponder", fields: [respondedById], references: [id], onDelete: SetNull)

  @@index([eventId])
  @@index([organizationId, requestStatus])
  @@index([respondedById])
}

// ─── Feature Gating ────────────────────────────────────────────────────

model TenantModule {
  id             String   @id @default(cuid())
  organizationId String
  moduleId       String   // 'athletics', 'planning-season', etc.
  enabledAt      DateTime @default(now())
  planTier       String?  // Which subscription tier enabled this

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, moduleId])
  @@index([organizationId])
}

// ─── Calendar Enums ────────────────────────────────────────────────────

enum CalendarType {
  ACADEMIC
  STAFF
  TIMETABLE
  PARENT_FACING
  ATHLETICS
  GENERAL
}

enum CalendarVisibility {
  PUBLIC
  ORG_WIDE
  CAMPUS
  ROLE_RESTRICTED
  PRIVATE
}

enum CalendarEventStatus {
  DRAFT
  PENDING_APPROVAL
  CONFIRMED
  TENTATIVE
  REJECTED
  CANCELLED
}

enum RSVPStatus {
  ACCEPTED
  DECLINED
  TENTATIVE
  PENDING
}

enum SyncProvider {
  GOOGLE
  MICROSOFT
  APPLE
}

enum SyncStatus {
  ACTIVE
  PAUSED
  ERROR
  DISCONNECTED
}

enum SpecialDayType {
  HOLIDAY
  CLOSURE
  EARLY_DISMISSAL
  LATE_START
  PROFESSIONAL_DEVELOPMENT
  TESTING
  OTHER
}

enum PlanningPhase {
  SETUP
  COLLECTING
  REVIEWING
  WAR_ROOM
  FINALIZING
  APPROVING
  CLOSED
}

enum PlanningSubmissionStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED_IN_PRINCIPLE
  NEEDS_REVISION
  DECLINED
  FINALIZING
  AWAITING_APPROVAL
  APPROVED
  PUBLISHED
}

enum SubmissionPriority {
  MUST_HAVE
  IMPORTANT
  NICE_TO_HAVE
}

enum ConflictType {
  DATE_OVERLAP
  FACILITY_CONFLICT
  STAFF_CONFLICT
  AUDIENCE_OVERLAP
  BUDGET_EXCEEDED
  DEPARTMENT_CLUSTERING
  WEATHER_CONCERN
  RESOURCE_BOTTLENECK
}

enum ConflictSeverity {
  CRITICAL
  WARNING
  INFO
}

enum ApprovalChannel {
  ADMIN
  FACILITIES
  AV_PRODUCTION
  CUSTODIAL
  SECURITY
  ATHLETIC_DIRECTOR
}

enum ApprovalMode {
  REQUIRED
  NOTIFICATION
  DISABLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  AUTO_APPROVED
  SKIPPED
}

enum ResourceRequestType {
  FACILITY
  AV_EQUIPMENT
  VIP_ATTENDANCE
  CUSTODIAL
}

enum ResourceRequestStatus {
  PENDING
  APPROVED
  DECLINED
  FULFILLED
  CANCELLED
}
