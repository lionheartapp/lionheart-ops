generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                   String               @id @default(cuid())
  name                 String
  slug                 String               @unique
  plan                 String               @default("PRO_TRIAL")  // FREE | PRO_TRIAL | CORE | PRO | ENTERPRISE
  trialEndsAt          DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  subscriptionStatus   String?               // 'active' | 'past_due' | 'canceled'
  logoUrl              String?
  website              String?
  address              String?               // Street address
  city                 String?
  state                String?
  zip                  String?
  primaryColor         String?               // e.g. #3b82f6
  secondaryColor       String?               // e.g. #f59e0b
  settings             Json?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  budgets              Budget[]
  buildings            Building[]
  events               Event[]
  expenses             Expense[]
  forms               Form[]
  inventoryItems      InventoryItem[]
  knowledgeBaseEntries KnowledgeBaseEntry[]
  maintenanceTips      MaintenanceTip[]
  pondConfigs          PondConfig[]
  pondLogs             PondLog[]
  tickets              Ticket[]
  users                User[]
  auditLogs            AuditLog[]

  @@index([plan])
}

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String?
  userId         String?
  action         String   // CREATE | UPDATE | DELETE
  entityType     String   // Ticket, Event, Form, User, etc.
  entityId       String?
  metadata       Json?    // additional context (old/new values, etc.)
  createdAt      DateTime @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model User {
  id               String            @id @default(cuid())
  organizationId   String?
  email            String            @unique
  name             String?
  imageUrl         String?
  role             UserRole          @default(VIEWER)
  canSubmitEvents  Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  passwordHash     String?
  submittedEvents  Event[]           @relation("SubmittedEvents")
  teacherSchedules TeacherSchedule[]
  assignedTickets  Ticket[]          @relation("AssignedTickets")
  submittedTickets Ticket[]          @relation("SubmittedTickets")
  organization     Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Building {
  id             String            @id @default(cuid())
  organizationId String?
  name           String
  division       BuildingDivision?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organization   Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rooms          Room[]

  @@index([organizationId])
}

model Room {
  id               String            @id @default(cuid())
  buildingId       String
  name             String
  matterportUrl    String?
  panoramaImageUrl String?
  coordinates      Json?
  pinYaw           Float?
  pinPitch         Float?
  adjacentRoomIds  String[]          @default([])
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  organizationId   String?           @db.Uuid
  events           Event[]
  building         Building          @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  teacherSchedules TeacherSchedule[]
  tickets          Ticket[]
}

model TeacherSchedule {
  id        String   @id @default(cuid())
  userId    String
  roomId    String
  dayOfWeek Int
  startTime String
  endTime   String
  subject   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([roomId])
  @@index([dayOfWeek])
}

model Ticket {
  id                      String           @id @default(cuid())
  organizationId          String?
  title                   String
  description             String?
  category                TicketCategory
  status                  TicketStatus     @default(NEW)
  priority                TicketPriority   @default(NORMAL)
  manHours                Float?
  safetyProtocolChecklist Json?
  roomId                  String?
  submittedById           String?
  assignedToId            String?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  Expense                 Expense[]
  MaintenanceTip          MaintenanceTip[]
  assignedTo              User?            @relation("AssignedTickets", fields: [assignedToId], references: [id])
  organization            Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  room                    Room?            @relation(fields: [roomId], references: [id])
  submittedBy             User?            @relation("SubmittedTickets", fields: [submittedById], references: [id])

  @@index([organizationId])
  @@index([category])
  @@index([status])
  @@index([submittedById])
  @@index([assignedToId])
}

model Event {
  id              String        @id @default(cuid())
  organizationId  String?
  name            String
  description     String?
  date            String
  startTime       String
  endTime         String?
  roomId          String?
  chairsRequested Int?
  tablesRequested Int?
  status          EventStatus   @default(PENDING_APPROVAL)
  submittedById   String?
  routedToIds     String[]      @default([])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  room            Room?         @relation(fields: [roomId], references: [id])
  submittedBy     User?         @relation("SubmittedEvents", fields: [submittedById], references: [id])

  @@index([organizationId])
  @@index([date])
  @@index([roomId])
  @@index([submittedById])
}

model Expense {
  id             String        @id @default(cuid())
  organizationId String?
  ticketId       String?
  vendor         String
  expenseDate    String
  total          Float
  receiptUrl     String?
  ocrData        Json?
  manHours       Float?
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Ticket         Ticket?       @relation(fields: [ticketId], references: [id])

  @@index([organizationId])
  @@index([expenseDate])
  @@index([ticketId])
}

model Budget {
  id             String        @id @default(cuid())
  organizationId String?
  category       String
  amount         Float
  yearMonth      String
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([category, yearMonth])
  @@index([organizationId])
  @@index([yearMonth])
}

model MaintenanceTip {
  id             String        @id @default(cuid())
  organizationId String?
  content        String
  sourceTicketId String?
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Ticket         Ticket?       @relation(fields: [sourceTicketId], references: [id])

  @@index([organizationId])
  @@index([sourceTicketId])
}

model Form {
  id               String            @id @default(cuid())
  organizationId   String?
  title            String
  description      String            @default("")
  config           Json?             // fields, layout, approvalWorkflow, submissionType, etc.
  createdBy        String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  organization     Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  submissions      FormSubmission[]

  @@index([organizationId])
}

model FormSubmission {
  id         String   @id @default(cuid())
  formId     String
  data       Json     // field id -> value map
  status     String   @default("submitted") // submitted | pending | approved | rejected
  approvals  Json?    // [{ approverId, approved, at }]
  submittedBy String?
  eventId    String?
  createdAt  DateTime @default(now())
  form       Form     @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([submittedBy])
}

model KnowledgeBaseEntry {
  id             String        @id @default(cuid())
  organizationId String?
  partName       String
  keywords       String[]      @default([])
  manualUrl      String?
  repairSteps    String[]      @default([])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([partName])
}

model InventoryItem {
  id             String           @id @default(cuid())
  organizationId String?
  name           String
  teamId         String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organization   Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stock          InventoryStock[]

  @@index([organizationId])
}

model InventoryStock {
  id        String        @id @default(cuid())
  itemId    String
  location  String
  quantity  Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  item      InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([location])
}

model PondLog {
  id              String        @id @default(cuid())
  organizationId  String?
  pH              Float
  turbidity       Float
  temperature     Float
  dissolvedOxygen Float?
  alkalinity      Float?
  source          String        @default("manual")
  notes           String?
  createdAt       DateTime      @default(now())
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([createdAt])
}

model PondConfig {
  id             String        @id @default(cuid())
  organizationId String?
  key            String        @unique
  value          Json
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

enum UserRole {
  SUPER_ADMIN
  TEACHER
  MAINTENANCE
  ADMIN
  SITE_SECRETARY
  VIEWER
}

enum BuildingDivision {
  ELEMENTARY
  MIDDLE
  HIGH
}

enum TicketCategory {
  MAINTENANCE
  IT
  EVENT
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  RESOLVED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

enum EventStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
}
