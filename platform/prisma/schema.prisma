// School Facility Management - Prisma Schema
// Use Supabase Postgres: add DATABASE_URL to .env (Supabase provides this)
// SaaS: Add organizationId to tenant-scoped models when multi-tenant.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // Transaction pooler (Port 6543)
  directUrl = env("DIRECT_URL")     // Direct connection (Port 5432)
}

// --- Organization (Tenant): For multi-tenant SaaS ---
model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique // e.g. "linfield-christian" for subdomain/custom domain
  logoUrl   String?
  website   String?
  settings  Json?     // Feature flags: { campusMap, aiForms, receiptOcr, ... }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  buildings            Building[]
  users                User[]
  events               Event[]
  tickets              Ticket[]
  pondLogs             PondLog[]
  pondConfigs          PondConfig[]
  inventoryItems       InventoryItem[]
  budgets              Budget[]
  expenses             Expense[]
  maintenanceTips      MaintenanceTip[]
  knowledgeBaseEntries KnowledgeBaseEntry[]
}

// --- Users: Roles for Teacher, Maintenance, Admin, Site Secretary ---
model User {
  id               String   @id @default(cuid())
  organizationId   String?  // SaaS: scopes to tenant (nullable for migration; required after backfill)
  email            String   @unique // Will become @@unique([organizationId, email]) after backfill
  passwordHash     String?  // bcrypt hash; null for OAuth users
  name             String?
  imageUrl         String?  // Photo/avatar for side panel
  role             UserRole @default(VIEWER)
  canSubmitEvents  Boolean  @default(false) // Teachers need this granted by admin
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teacherSchedules TeacherSchedule[]
  submittedTickets  Ticket[]      @relation("SubmittedTickets")
  assignedTickets  Ticket[]      @relation("AssignedTickets")
  submittedEvents  Event[]       @relation("SubmittedEvents")

  @@index([organizationId])
}

enum UserRole {
  TEACHER
  MAINTENANCE
  ADMIN
  SITE_SECRETARY
  VIEWER
}

// --- Buildings & Rooms: Matterport_URL and Coordinates ---
model Building {
  id             String       @id @default(cuid())
  organizationId String?      // SaaS: scopes to tenant (nullable for migration; required after backfill)
  name           String
  division       BuildingDivision? // ELEMENTARY, MIDDLE, HIGH for routing
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rooms        Room[]

  @@index([organizationId])
}

enum BuildingDivision {
  ELEMENTARY
  MIDDLE
  HIGH
}

model Room {
  id                 String   @id @default(cuid())
  buildingId         String
  name               String
  matterportUrl      String?   // Matterport 3D tour URL
  panoramaImageUrl   String?  // Equirectangular image for Pannellum 360 viewer
  coordinates        Json?    // { lat, lng } for 2D map
  pinYaw             Float?   // Yaw (horizontal deg) for pin in 360 panorama
  pinPitch           Float?   // Pitch (vertical deg) for pin in 360 panorama
  adjacentRoomIds    String[] @default([]) // Room IDs for proximal conflict check
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  building         Building         @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  teacherSchedules TeacherSchedule[]
  tickets          Ticket[]
  events           Event[]
}

// --- TeacherSchedules: DayOfWeek, StartTime, EndTime, RoomID, Subject ---
model TeacherSchedule {
  id        String   @id @default(cuid())
  userId    String
  roomId    String
  dayOfWeek Int     // 0=Sunday, 1=Monday, ... 6=Saturday
  startTime String  // e.g. "08:00"
  endTime   String  // e.g. "09:15"
  subject   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([roomId])
  @@index([dayOfWeek])
}

// --- Tickets: Category (Maintenance/IT/Event), Status, Priority, ManHours, SafetyProtocolChecklist ---
model Ticket {
  id                     String       @id @default(cuid())
  organizationId         String?      // SaaS: scopes to tenant (nullable for migration)
  title                  String
  description            String?
  category               TicketCategory
  status                 TicketStatus  @default(NEW)
  priority               TicketPriority @default(NORMAL)
  manHours               Float?       // Estimated or actual hours
  safetyProtocolChecklist Json?       // JSON checklist for safety protocols
  roomId                 String?
  submittedById          String?
  assignedToId           String?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  room        Room?   @relation(fields: [roomId], references: [id], onDelete: SetNull)
  submittedBy User?   @relation("SubmittedTickets", fields: [submittedById], references: [id], onDelete: SetNull)
  assignedTo  User?   @relation("AssignedTickets", fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([category])
  @@index([status])
  @@index([submittedById])
  @@index([assignedToId])
}

enum TicketCategory {
  MAINTENANCE
  IT
  EVENT
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  RESOLVED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

// --- Events: Facility event requests (parsed by LLM, routed by division) ---
model Event {
  id              String    @id @default(cuid())
  organizationId  String?   // SaaS: scopes to tenant (nullable for migration)
  name            String
  description     String?
  date            String    // YYYY-MM-DD
  startTime       String    // HH:MM
  endTime         String?   // HH:MM
  roomId          String?
  chairsRequested Int?
  tablesRequested Int?
  status          EventStatus   @default(PENDING_APPROVAL)
  submittedById   String?
  routedToIds     String[]      @default([]) // User IDs notified (Principal, Maintenance, etc.)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  room        Room? @relation(fields: [roomId], references: [id], onDelete: SetNull)
  submittedBy User? @relation("SubmittedEvents", fields: [submittedById], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([date])
  @@index([roomId])
  @@index([submittedById])
}

enum EventStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

// --- Expenses: Receipt OCR data from ticket completion ---
model Expense {
  id           String   @id @default(cuid())
  organizationId String?  // SaaS: scopes to tenant (nullable for migration)
  ticketId     String?  // Links to platform Ticket; Vite app uses numeric id
  vendor       String
  expenseDate  String   // YYYY-MM-DD from receipt
  total        Float
  receiptUrl   String?  // Stored image URL if uploaded
  ocrData      Json?    // Raw OCR result
  manHours     Float?
  createdAt    DateTime @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([expenseDate])
  @@index([ticketId])
}

// --- Budget: For monthly spend vs budget report ---
model Budget {
  id           String   @id @default(cuid())
  organizationId String?  // SaaS: scopes to tenant (nullable for migration)
  category     String   // e.g. "facilities", "it"
  amount       Float
  yearMonth    String   // e.g. "2025-02"
  createdAt    DateTime @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([category, yearMonth]) // Will become @@unique([organizationId, category, yearMonth]) after backfill
  @@index([organizationId])
  @@index([yearMonth])
}

// --- MaintenanceTip: Future takeaways from completed tickets → KnowledgeBase ---
model MaintenanceTip {
  id             String   @id @default(cuid())
  organizationId String?  // SaaS: scopes to tenant (nullable for migration)
  content        String
  sourceTicketId String?
  createdAt      DateTime @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([sourceTicketId])
}

// --- KnowledgeBase: Manuals and repair guides for Visual AI ---
model KnowledgeBaseEntry {
  id             String   @id @default(cuid())
  organizationId String?  // SaaS: scopes to tenant (nullable for migration)
  partName       String   // e.g. "Projector lamp", "HVAC filter"
  keywords       String[] @default([]) // Alternative names for matching
  manualUrl      String?  // Link to PDF or web manual
  repairSteps    String[] @default([]) // 3-step repair summary
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([partName])
}

// --- Inventory: Shared resources like Tables and Chairs ---
model InventoryItem {
  id             String   @id @default(cuid())
  organizationId String?  // SaaS: scopes to tenant (nullable for migration)
  name           String   // e.g. "8' Table", "Folding Chair"
  teamId         String?  // Scope: facilities, av, it, etc.
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stock        InventoryStock[]

  @@index([organizationId])
}

model InventoryStock {
  id        String   @id @default(cuid())
  itemId    String
  location  String   // e.g. "Gym", "Auditorium"
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([location])
}

// --- Pond Maintenance: IoT sensor data + manual readings ---
model PondLog {
  id              String   @id @default(cuid())
  organizationId  String?  // SaaS: scopes to tenant (nullable for migration)
  pH              Float
  turbidity       Float    // NTU
  temperature     Float    // Celsius (convert from °F in UI if needed)
  dissolvedOxygen Float?   // ppm (aeration trigger when < 5)
  alkalinity      Float?   // ppm (Copper safety: min 50)
  source          String   @default("manual") // "sensor" | "manual"
  notes           String?
  createdAt       DateTime @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([createdAt])
}

// --- Pond Constants: SafeZone & dosing config (single row per org, JSON config) ---
model PondConfig {
  id             String   @id @default(cuid())
  organizationId String?  // SaaS: scopes to tenant (nullable for migration)
  key            String   // e.g. "safezone", "pond_volume"
  value          Json     // { pHMin, pHMax, turbidityMax, volumeGallons, ... }
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([key]) // Will become @@unique([organizationId, key]) after backfill
  @@index([organizationId])
}
